#!/bin/bash

get_dir() {
    local script_path; script_path=$(readlink -f "$0")
    local script_dir; script_dir=$(dirname "$script_path")
    echo "$script_dir"
}

dump_database() {
    backup_path="$1"
    ./postgres dump > $backup_path
}

dump_attachments() {
    backup_path="$1"
    cd $COOG_DATA/coog/edm/ && tar -cz -f "$backup_path" $db_name
    cd -
}

usage() {
    echo
    echo "Backup command:"
    echo
    echo "  Backup database and attachments in /mnt/coog_backup/"
    echo
    echo "Usage:"
    echo 
    echo "  PGPASSWORD=<postgres_password> ./backup"
    echo
}

main() {
    source "$(get_dir)/config"
    [[ $# -ne 0 || -z $PGPASSWORD ]] && usage && exit 1
    [[ -z "$COOG_DATA" ]] && echo "\$COOG_DATA must be set" && exit 1

    container_name="$NETWORK_NAME-postgres"
    db_name="$COOG_DB_NAME"

    echo $PGPASSWORD

    if [[ $(date '+%m%d') == 0101 ]]; then
        dump_database "/mnt/coog_backup/db-$(date '+%Y').dump.gz"
    fi

    if [[ $(date '+%d') == 01 ]]; then
        dump_database "/mnt/coog_backup/db-$(date '+%B').dump.gz"
    fi

    if [[ $(date '+%u') == 0 ]]; then
        dump_database "/mnt/coog_backup/db-week-$(date '+%V').dump.gz"
    fi

    dump_database "/mnt/coog_backup/db-$db_name-$(date '+%A').dump.gz"
    dump_attachments "/mnt/coog_backup/attachments-$db_name-$(date '+%A').tar.gz"
}

main "$@"
