#!/bin/bash

get_dir() {
    local script_path; script_path=$(readlink -f "$0")
    local script_dir; script_dir=$(dirname "$script_path")
    echo "$script_dir"
}

dump_database() {
    if $(get_dir)/postgres dump -Fc > "$BACKUP_DIRECTORY/$1"; then
        echo "dump db -> OK"
        return 0
    else
        echo "dump db -> KO"
        return 1
    fi
}

dump_attachments() {
    SECONDS=0
    docker run -i --rm \
        -v /tmp:/tmp \
        --volumes-from "$USER"-coog-server \
        alpine:3.6 \
        tar czf /tmp/"$1" /workspace/io/edm/"$COOG_DB_NAME" &&
        cp /tmp/"$1" "$BACKUP_DIRECTORY/"
    local status_code=$?
    duration=$SECONDS
    echo "job time :$(($duration / 60)) min $(($duration % 60)) s"
    return $status_code
}

usage() {
    echo
    echo "Available command:"
    echo
    echo "  save    -> Backup database and attachments in $BACKUP_DIRECTORY/"
    echo "  clean   -> Remove old backups "
    echo
}

save() {
    source "$(get_dir)/config"
    [[ $# -ne 0 ]] && usage && exit 1

    [ ! -d "$BACKUP_DIRECTORY" ] && mkdir -p "$BACKUP_DIRECTORY"

    local status_code=0;

    # check if there is a yearly backup
    YEAR=$(date '+%Y')
    if [ $(ls -1 $BACKUP_DIRECTORY/ | grep -c "year-$YEAR-db") -eq 0 ];
    then
        echo "saving yearly db and attachments"
        dump_database "year-$YEAR-db-$NETWORK_NAME-$COOG_DB_NAME.dump.gz" || status_code=$?
        dump_attachments "year-$YEAR-attachments-$NETWORK_NAME-$COOG_DB_NAME.tar.gz" || status_code=$?
    fi

    # check if there is a monthly backup
    MONTH=$(date '+%Y%m')
    if [ $(ls -1 $BACKUP_DIRECTORY/ | grep -c "month-$MONTH-db") -eq 0 ];
    then
        echo "saving monthly db and attachments"
        dump_database "month-$MONTH-db-$NETWORK_NAME-$COOG_DB_NAME.dump.gz" || status_code=$?
        dump_attachments "month-$MONTH-attachments-$NETWORK_NAME-$COOG_DB_NAME.tar.gz" || status_code=$?
    fi

    # weekly backup on Friday
    WEEK=$(date '+%V')
    if [[ $(date '+%u') == 5 ]]; then
        echo "saving weekly db and attachments"
        dump_database "week-$WEEK-db-$NETWORK_NAME-$COOG_DB_NAME.dump.gz" || status_code=$?
        dump_attachments "week-$WEEK-attachments-$NETWORK_NAME-$COOG_DB_NAME.tar.gz" || status_code=$?
    fi

    echo "saving daily db and attachments"
    dump_database "$(date '+%Y%m%d')-daily-db-$NETWORK_NAME-$COOG_DB_NAME.dump.gz" || status_code=$?
    dump_attachments "$(date '+%Y%m%d')-daily-attachments-$NETWORK_NAME-$COOG_DB_NAME.tar.gz" || status_code=$?

    return $status_code
}

clean() {
    source "$(get_dir)/config"
    [[ $# -ne 0 ]] && usage && exit 1

    stock_daily_db="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'daily\-db') - 7)"
    stock_weekly_db="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'week.*db') - 4)"
    stock_monthly_db="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'month.*db') - 3)"
    stock_yearly_db="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'year.*db') - 2)"

    stock_daily_attach="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'daily\-attachments') - 7)"
    stock_weekly_attach="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'week.*attachments') - 4)"
    stock_monthly_attach="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'month.*attachments') - 3)"
    stock_yearly_attach="$(expr $(ls -1 $BACKUP_DIRECTORY/ | grep -c 'year.*attachments') - 2)"

    if [[ $stock_daily_db -gt 0 ]]; then
        echo "cleaning daily db"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*daily-db* | tail -$stock_daily_db)
    fi

    if [[ $stock_weekly_db -gt 0 ]]; then
        echo "cleaning weekly db"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*week*db* | tail -$stock_weekly_db)
    fi

    if [[ $stock_monthly_db -gt 0 ]]; then
        echo "cleaning monthly db"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*month*db* | tail -$stock_monthly_db)
    fi

    if [[ $stock_yearly_db -gt 0 ]]; then
        echo "cleaning yearly db"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*year*db* | tail -$stock_yearly_db)
    fi

    if [[ $stock_daily_attach -gt 0 ]]; then
        echo "clean daily attachments"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*daily-attachments* | tail -$stock_daily_attach)
    fi

    if [[ $stock_weekly_attach -gt 0 ]]; then
        echo "cleaning weekly attachments"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*week*attachments* | tail -$stock_weekly_db)
    fi

    if [[ $stock_monthly_attach -gt 0 ]]; then
        echo "cleaning monthly attachments"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*month*attachments* | tail -$stock_monthly_db)
    fi

    if [[ $stock_yearly_attach -gt 0 ]]; then
        echo "cleaning yearly attachments"
        cd $BACKUP_DIRECTORY && rm $(ls -t $BACKUP_DIRECTORY/*year*attachments* | tail -$stock_yearly_db)
    fi
}

main() {
    [ -z "$1" ] && usage && return 0
    local cmd; cmd=$1; shift
    #
    [ "$cmd" = "save" ] && { save "$@"; return $?; }
    [ "$cmd" = "clean" ] && { clean "$@"; return $?; }
    action "$cmd" "$@"
}

main "$@"
